<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prime Regenerative Clinic Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    :root{
      --bg:#0b0e13;
      --panel:#11161f;
      --muted:#9aa4b2;
      --text:#e8ecf3;
      --standard:#3a3f46;
      --verified:#72BDDC;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background:#000;
      color:var(--text);
    }

    /* TOP BAR */
    .topbar{
      height:84px;
      background:#000;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 32px;
      position:relative;
      z-index:10;
    }
    .topbar img{
      height:52px;
    }
    .topbar a{
      color:#dbe3f1;
      text-decoration:none;
      margin-left:32px;
      font-size:16px;
      font-weight:500;
    }
    .topbar a:hover{color:#fff}

    /* LAYOUT */
    .wrap{
      display:grid;
      grid-template-columns:380px 1fr;
      height:calc(100vh - 84px);
    }

    /* SIDEBAR */
    .sidebar{
      background:linear-gradient(180deg,#0d1118,#0b0e13);
      padding:28px;
      overflow:auto;
      border-right:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .sidebar h1{
      font-size:24px;
      line-height:1.3;
      margin:0 0 14px;
    }
    .sidebar p{
      color:var(--muted);
      font-size:15px;
      margin:0 0 22px;
    }

    .filter h3{
      font-size:11px;
      letter-spacing:.14em;
      color:#8f98a7;
      margin:26px 0 10px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .chip{
      padding:7px 14px;
      border-radius:999px;
      background:#151b26;
      font-size:14px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.08);
      user-select:none;
    }
    .chip.active{
      border-color:rgba(114,189,220,.75);
      box-shadow:0 0 0 4px rgba(114,189,220,.16);
    }

    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:#151b26;
      padding:12px 14px;
      border-radius:10px;
      font-size:15px;
    }

    .count{
      margin-top:16px;
      font-size:14px;
      color:#9fb0c7;
    }

    /* MAP */
    #map{width:100%;height:100%}

    /* MARKERS */
    .marker{
      width:14px;height:14px;border-radius:50%;
      background:var(--standard);
      box-shadow:0 6px 14px rgba(0,0,0,.45);
      cursor:pointer;
    }
    .marker.verified{
      width:18px;height:18px;
      background:var(--verified);
      box-shadow:
        0 8px 18px rgba(0,0,0,.5),
        0 0 0 7px rgba(114,189,220,.28);
    }

    /* SIDE PANEL */
    .panel{
      position:absolute;
      top:84px;
      right:0;
      width:380px;
      height:calc(100vh - 84px);
      background:var(--panel);
      border-left:1px solid rgba(255,255,255,.1);
      padding:26px;
      transform:translateX(100%);
      transition:.25s ease;
      z-index:9;
      overflow:auto;
    }
    .panel.open{transform:none}
    .panel h2{margin:0 0 6px}
    .badge{
      color:var(--verified);
      font-size:15px;
      font-weight:600;
      margin:6px 0 14px;
      text-shadow:0 0 18px rgba(114,189,220,.45);
    }
    .panel p{
      color:var(--muted);
      font-size:15px;
      margin:6px 0;
    }
    .panel a{
      display:block;
      margin-top:22px;
      padding:14px;
      text-align:center;
      background:var(--verified);
      color:#001018;
      font-weight:700;
      text-decoration:none;
      border-radius:10px;
    }
    .panel a:hover{filter:brightness(1.05)}
    .panel .logo{
      width:84px;height:84px;
      object-fit:contain;
      border-radius:10px;
      background:#0b0e13;
      border:1px solid rgba(255,255,255,.08);
      margin:10px 0 14px;
      display:block;
    }

    /* FOOTER */
    .dir-footer{
      position:absolute;
      bottom:0;
      left:0;
      width:100%;
      padding:16px 24px;
      font-size:13px;
      color:#9aa4b2;
      border-top:1px solid rgba(255,255,255,.08);
      background:#0b0e13;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .dir-footer a{
      color:#9fb0c7;
      text-decoration:none;
      margin-left:18px;
    }
    .dir-footer a:hover{color:#fff}

    /* MOBILE */
    @media(max-width:900px){
      .wrap{grid-template-columns:1fr}
      .sidebar{display:none}
      .panel{width:100%}
    }
  </style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <img src="https://storage.googleapis.com/msgsndr/HjPB77l6JDSqhEzt2YNT/media/66c4a87c66f58d551de0ed1f.png" alt="Prime Regenerative">
  <div>
    <a href="https://www.primeregenerative.com/" target="_blank" rel="noopener">Home</a>
    <a href="https://primeregenerative.com/verified-directory" target="_blank" rel="noopener">About Prime Verified</a>
    <a href="https://primeregenerative.com/verified-directory" target="_blank" rel="noopener">Clinic Owner?</a>
  </div>
</div>

<div class="wrap">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h1>Highly Recommended Regenerative & Functional Clinics Across the USA</h1>
    <p>Clinics listed here have been reviewed and approved through the Prime Regenerative screening process.</p>

    <div class="filter" id="typeFilter">
      <h3>TYPE</h3>
      <div class="chips">
        <div class="chip active" data-type="all">All</div>
        <div class="chip" data-type="regenerative">Regenerative</div>
        <div class="chip" data-type="functional">Functional</div>
      </div>
    </div>

    <div class="filter" id="serviceFilter">
      <h3>SERVICES</h3>
      <div class="chips">
        <div class="chip" data-service="PRP">PRP</div>
        <div class="chip" data-service="Exosomes">Exosomes</div>
        <div class="chip" data-service="Wharton's Jelly">Wharton's Jelly</div>
        <div class="chip" data-service="Shockwave">Shockwave</div>
        <div class="chip" data-service="Peptides">Peptides</div>
        <div class="chip" data-service="Hormone Therapy">Hormone Therapy</div>
        <div class="chip" data-service="IV Therapy">IV Therapy</div>
        <div class="chip" data-service="Joint Pain">Joint Pain</div>
        <div class="chip" data-service="Hair Loss">Hair Loss</div>
        <div class="chip" data-service="Weight Loss">Weight Loss</div>
      </div>
    </div>

    <div class="filter">
      <h3>VERIFIED</h3>
      <div class="toggle">
        <span>Verified only</span>
        <input type="checkbox" id="verifiedOnly">
      </div>
    </div>

    <div class="count" id="count">Loading clinics…</div>

    <!-- FOOTER -->
    <div class="dir-footer">
      <div>© 2025 Prime Regenerative</div>
      <div>
        <a href="https://primeregenerative.com/privacy" target="_blank" rel="noopener">Privacy</a>
        <a href="https://primeregenerative.com/terms-of-service-7568" target="_blank" rel="noopener">Terms</a>
        <a href="https://primeregenerative.com/verified-directory" target="_blank" rel="noopener">Clinic Owner?</a>
      </div>
    </div>
  </aside>

  <!-- MAP -->
  <div id="map"></div>
</div>

<!-- SIDE PANEL -->
<div class="panel" id="panel"></div>

<script>
  /* MAPBOX TOKEN */
  mapboxgl.accessToken =
    'pk.eyJ1IjoicHJpbWVyZWdlbmVyYXRpdmUiLCJhIjoiY21rZTk1dHB4MDRiYjNlcHBheTJubGh0ayJ9.R9IN8o-u1xnjry7a8BkMsw';

  /* APPS SCRIPT ENDPOINT (APPROVED-ONLY JSON) */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxs9SA3C7rRMgoxWNTFqZ5Ouyy603WpIgczlwvANtlvmHWfCI5QSwXb0BJvax5MqCGF/exec';

  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/light-v11',
    center:[-98,39],
    zoom:3.4
  });
  map.addControl(new mapboxgl.NavigationControl());

  const panel = document.getElementById('panel');
  const countEl = document.getElementById('count');

  // Filter state
  let TYPE = 'all';          // all | regenerative | functional
  let SERVICE = null;        // string or null
  let VERIFIED_ONLY = false; // boolean

  // Data
  let ALL = [];              // normalized clinic objects
  let markers = [];          // Mapbox markers

  function normalizeType(row){
    // Prefer strict enum if you store it as "functional"/"regenerative"
    const raw = String(row.type || '').toLowerCase().trim();
    if (raw === 'functional' || raw === 'regenerative') return raw;
    if (raw.includes('functional')) return 'functional';
    if (raw.includes('regenerative')) return 'regenerative';
    return raw || 'regenerative';
  }

  function isVerified(row){
    // Verified rule: tier === "verified"
    return String(row.tier || '').toLowerCase().trim() === 'verified';
  }

  function normalizeServices(row){
    // Sheet stores "A, B, C" string
    return String(row.services || '')
      .split(',')
      .map(s => s.trim())
      .filter(Boolean);
  }

  function toClinic(row){
    return {
      id: row.id || '',
      name: row.clinic_name || row.name || 'Unnamed Clinic',
      slug: row.slug || '',
      type: normalizeType(row),
      verified: isVerified(row),
      address: row.address || '',
      city: [row.city, row.state].filter(Boolean).join(', '),
      lat: Number(row.lat),
      lng: Number(row.lng),
      phone: String(row.phone || ''),
      website: row.website || '#',
      internal_email: row.internal_email || '',
      public_email: row.public_email || '',
      services: normalizeServices(row),
      services_raw: String(row.services || ''),
      description: row.description || '',
      accepting_new_patients: String(row.accepting_new_patients || ''),
      telehealth: String(row.telehealth || ''),
      financing_available: String(row.financing_available || ''),
      tier: String(row.tier || ''),
      verified_until: String(row.verified_until || ''),
      logo_url: row.logo_url || '',
      photos: row.photos || '',
      source: row.source || '',
      notes: row.notes || '',
      created_at: row.created_at || '',
      updated_at: row.updated_at || ''
    };
  }

  function passesFilters(c){
    if (!Number.isFinite(c.lat) || !Number.isFinite(c.lng)) return false;

    if (TYPE !== 'all' && c.type !== TYPE) return false;

    if (VERIFIED_ONLY && !c.verified) return false;

    if (SERVICE){
      const svc = SERVICE.toLowerCase();
      const has = c.services.some(s => s.toLowerCase() === svc);
      if (!has) return false;
    }

    return true;
  }

  function clearMarkers(){
    markers.forEach(m => m.remove());
    markers = [];
  }

  function openPanel(c){
    const logoHtml = c.logo_url
      ? `<img class="logo" src="${c.logo_url}" alt="${c.name} logo">`
      : '';

    panel.innerHTML = `
      <h2>${c.name}</h2>
      ${c.verified ? '<div class="badge">✔ Prime Verified Clinic</div>' : ''}
      ${logoHtml}
      <p>${c.city || c.address}</p>
      ${c.services.length ? `<p>${c.services.join(', ')}</p>` : ''}
      ${c.description ? `<p>${c.description}</p>` : ''}
      <a href="${c.website}" target="_blank" rel="noopener">Visit Clinic Website</a>
    `;
    panel.classList.add('open');
  }

  function render(){
    const list = ALL.filter(passesFilters);

    clearMarkers();

    list.forEach(c => {
      const el = document.createElement('div');
      el.className = 'marker' + (c.verified ? ' verified' : '');

      el.onclick = (e) => {
        e.stopPropagation();
        openPanel(c);
      };

      const marker = new mapboxgl.Marker(el)
        .setLngLat([c.lng, c.lat])
        .addTo(map);

      markers.push(marker);
    });

    if (countEl) countEl.textContent = `${list.length} clinics shown`;
  }

  function wireUI(){
    // TYPE chips
    document.querySelectorAll('#typeFilter .chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('#typeFilter .chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        TYPE = chip.dataset.type || 'all';
        render();
      });
    });

    // SERVICE chips (single-select; click again to clear)
    document.querySelectorAll('#serviceFilter .chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const svc = chip.dataset.service || null;
        const isActive = chip.classList.contains('active');

        document.querySelectorAll('#serviceFilter .chip').forEach(c => c.classList.remove('active'));

        if (isActive){
          SERVICE = null;
        } else {
          chip.classList.add('active');
          SERVICE = svc;
        }

        render();
      });
    });

    // Verified only toggle
    const v = document.getElementById('verifiedOnly');
    v.addEventListener('change', () => {
      VERIFIED_ONLY = !!v.checked;
      render();
    });

    // Close panel when clicking map
    map.on('click', () => panel.classList.remove('open'));
  }

  async function loadClinics(){
    countEl.textContent = 'Loading clinics…';
    try{
      const res = await fetch(ENDPOINT, { cache: 'no-store' });
      const rows = await res.json();
      ALL = (Array.isArray(rows) ? rows : []).map(toClinic);
      render();
    }catch(err){
      console.error('Failed to load clinics', err);
      countEl.textContent = 'Failed to load clinics';
    }
  }

  wireUI();
  loadClinics();
</script>

</body>
</html>

