<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prime Regenerative Clinic Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    :root{
      --bg:#0b0e13;
      --panel:#11161f;
      --muted:#9aa4b2;
      --text:#e8ecf3;
      --standard:#3a3f46;
      --verified:#7DCBEA;
      --card:#121824;
      --card2:#0f151f;
      --line:rgba(255,255,255,.08);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background:#000;
      color:var(--text);
    }

    /* TOP BAR */
    .topbar{
      height:84px;
      background:#000;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 32px;
      position:relative;
      z-index:10;
    }
    .topbar img{ height:52px; }
    .topbar a{
      color:#dbe3f1;
      text-decoration:none;
      margin-left:32px;
      font-size:16px;
      font-weight:500;
      transition: color 0.2s;
    }
    .topbar a:hover{color:#fff}

    /* LAYOUT */
    .wrap{
      display:grid;
      grid-template-columns:380px 1fr;
      height:calc(100vh - 84px);
      position:relative;
    }

    /* SIDEBAR */
    .sidebar{
      background:linear-gradient(180deg,#0d1118,#0b0e13);
      padding:22px 18px 0;
      overflow:hidden;
      border-right:1px solid var(--line);
      position:relative;
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .sidebar-scroll{
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      padding:0 0 16px 0;
    }
    .sidebar h1{
      font-size:28px;
      line-height:1.25;
      margin:0 0 12px;
      letter-spacing:.2px;
      font-weight:700;
    }
    .sidebar p{
      color:#c7d2e4;
      font-size:14px;
      margin:0 0 16px;
      line-height:1.5;
    }

    /* Search */
    .search{
      position:sticky;
      top:0;
      z-index:3;
      padding:10px 0 12px;
      margin:0 0 10px;
      background:linear-gradient(180deg,#0d1118 80%, rgba(13,17,24,0.95) 90%, rgba(13,17,24,0));
      backdrop-filter:saturate(1.1) blur(10px);
    }
    .search input{
      width:100%;
      padding:14px 16px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:#0f1520;
      color:var(--text);
      font-size:14px;
      outline:none;
      transition: all 0.2s;
    }
    .search input:focus{
      border-color:rgba(125,203,234,.4);
      box-shadow: 0 0 0 3px rgba(125,203,234,.12);
    }
    .search input::placeholder{color:#93a0b6}
    .search-row{
      display:flex;
      gap:10px;
      margin-top:10px;
      align-items:center;
      justify-content:space-between;
    }
    .clearBtn{
      border:1px solid rgba(255,255,255,.10);
      background:#0f1520;
      color:#cfe0ff;
      padding:10px 14px;
      border-radius:12px;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
      transition: all 0.2s;
    }
    .clearBtn:hover{
      filter:brightness(1.1);
      transform: translateY(-1px);
    }

    /* Active filter pills */
    .pills{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      background:#0f1520;
      border:1px solid rgba(255,255,255,.10);
      color:#dbe3f1;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition: all 0.2s;
    }
    .pill b{font-weight:700}
    .pill .x{opacity:.8}
    .pill:hover{
      filter:brightness(1.1);
      transform: translateY(-1px);
    }

    .filter h3{
      font-size:11px;
      letter-spacing:.14em;
      color:#aeb7c6;
      margin:20px 0 12px;
      font-weight:700;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .chip{
      padding:10px 16px;
      border-radius:999px;
      background:#151b26;
      font-size:14px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      user-select:none;
      transition: all 0.2s;
    }
    .chip:hover{
      filter:brightness(1.08);
      transform: translateY(-1px);
    }
    .chip.active{
      border-color:rgba(125,203,234,.85);
      box-shadow:0 0 0 4px rgba(125,203,234,.20);
      background:#1a2633;
    }

    /* Toggle */
    .toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:#151b26;
      padding:14px 16px;
      border-radius:12px;
      font-size:14px;
      border:1px solid rgba(255,255,255,.10);
    }
    .toggle span{color:#dbe3f1}
    .toggle input{transform:scale(1.1)}

    /* Count + breakdown */
    .count{
      margin-top:16px;
      font-size:15px;
      color:#dbe3f1;
      display:flex;
      gap:8px;
      align-items:baseline;
      justify-content:space-between;
      font-weight:600;
    }
    .count small{
      color:#b9c6dd;
      font-size:12px;
      white-space:nowrap;
      font-weight:400;
    }

    /* Clinic list */
    .list{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px;
      cursor:pointer;
      box-shadow:0 10px 20px rgba(0,0,0,.20);
      transition: all 0.2s;
    }
    .card:hover{
      filter:brightness(1.08);
      transform: translateY(-2px);
      box-shadow:0 14px 28px rgba(0,0,0,.25);
    }
    .card.verified{
      border-color:rgba(125,203,234,.3);
      box-shadow:
        0 10px 20px rgba(0,0,0,.20),
        0 0 0 1px rgba(125,203,234,.15);
    }
    .card.verified:hover{
      box-shadow:
        0 14px 28px rgba(0,0,0,.25),
        0 0 0 1px rgba(125,203,234,.25);
    }
    .cardTop{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .cardLogo{
      width:48px;height:48px;
      border-radius:12px;
      object-fit:contain;
      background:#0b0e13;
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .cardTitle{
      display:flex;
      flex-direction:column;
      min-width:0;
      flex:1;
    }
    .cardTitle strong{
      font-size:15px;
      line-height:1.3;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:600;
    }
    .cardTitle span{
      font-size:13px;
      color:#c7d2e4;
      margin-top:3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tag{
      font-size:11px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:#0f1520;
      color:#dbe3f1;
      flex:0 0 auto;
      font-weight:600;
    }
    .tag.verified{
      border-color:rgba(125,203,234,.7);
      box-shadow:0 0 0 4px rgba(125,203,234,.15);
      color:var(--verified);
      font-weight:700;
    }
    .cardServices{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .svcPill{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      background:#0f1520;
      border:1px solid rgba(255,255,255,.10);
      color:#dbe3f1;
    }

    /* MAP */
    #map{width:100%;height:100%}

    /* MARKERS */
    .marker{
      width:16px;height:16px;border-radius:50%;
      background:var(--standard);
      box-shadow:0 6px 14px rgba(0,0,0,.45);
      cursor:pointer;
      transition: all 0.2s;
      border: 2px solid rgba(255,255,255,.2);
    }
    .marker:hover{
      transform: scale(1.15);
    }
    .marker.verified{
      width:20px;height:20px;
      background:var(--verified);
      box-shadow:
        0 8px 18px rgba(0,0,0,.5),
        0 0 0 8px rgba(125,203,234,.35);
    }
    .marker.verified:hover{
      animation: pulse 1.5s ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 8px 18px rgba(0,0,0,.5), 0 0 0 8px rgba(125,203,234,.35); }
      50% { box-shadow: 0 8px 18px rgba(0,0,0,.5), 0 0 0 12px rgba(125,203,234,.2); }
    }

    /* SIDE PANEL (DETAIL) */
    .panel{
      position:absolute;
      top:84px;
      right:0;
      width:440px;
      max-width:92vw;
      height:calc(100vh - 84px);
      background:linear-gradient(180deg,#101622,#0c111a);
      border-left:1px solid rgba(255,255,255,.10);
      padding:24px 24px 0;
      transform:translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index:9;
      overflow:auto;
      box-shadow: -10px 0 40px rgba(0,0,0,.4);
    }
    .panel.open{transform:none}

    .panelHeader{
      display:flex;
      gap:16px;
      align-items:flex-start;
      margin-bottom:16px;
    }
    .panelLogo{
      width:80px;height:80px;
      border-radius:16px;
      object-fit:contain;
      background:#0b0e13;
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .panelTitle{
      min-width:0;
      flex:1;
    }
    .panelTitle h2{
      margin:0;
      font-size:24px;
      letter-spacing:.2px;
      line-height:1.3;
      font-weight:700;
    }
    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      margin-top:10px;
      color:var(--verified);
      font-size:14px;
      font-weight:800;
      text-shadow:0 0 20px rgba(125,203,234,.5);
    }
    .badge svg{
      width:18px;
      height:18px;
      fill:currentColor;
      filter: drop-shadow(0 0 8px rgba(125,203,234,.6));
    }

    .panelMeta{
      margin-top:18px;
      border-top:1px solid rgba(255,255,255,.10);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:16px 0;
    }
    .metaRow{
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin:12px 0;
      color:#dbe3f1;
      font-size:14px;
      line-height:1.5;
    }
    .metaIcon{
      width:20px;
      height:20px;
      opacity:.85;
      flex:0 0 auto;
      margin-top:2px;
      stroke:currentColor;
      fill:none;
      stroke-width:2;
      stroke-linecap:round;
      stroke-linejoin:round;
    }

    .desc{
      margin:18px 0;
      color:#dbe3f1;
      font-size:15px;
      line-height:1.65;
      background:rgba(255,255,255,.02);
      padding:16px;
      border-radius:12px;
      border-left:3px solid rgba(125,203,234,.3);
    }

    .contactGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin:18px 0;
    }
    .contactBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:14px;
      background:#151b26;
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      color:#dbe3f1;
      text-decoration:none;
      font-size:14px;
      font-weight:600;
      transition: all 0.2s;
    }
    .contactBtn svg{
      width:18px;
      height:18px;
      stroke:currentColor;
      fill:none;
      stroke-width:2;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .contactBtn:hover{
      filter:brightness(1.12);
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(0,0,0,.2);
    }

    .infoCards{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin:18px 0;
    }
    .infoCard{
      background:rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.08);
      border-radius:10px;
      padding:12px;
      text-align:center;
    }
    .infoCard-label{
      font-size:11px;
      color:#b9c6dd;
      text-transform:uppercase;
      letter-spacing:.1em;
      margin-bottom:6px;
      font-weight:600;
    }
    .infoCard-value{
      font-size:14px;
      color:#dbe3f1;
      font-weight:600;
    }
    .infoCard-value.yes{color:#7DCBEA}
    .infoCard-value.no{color:#93a0b6}

    .panelCta{
      position:sticky;
      bottom:0;
      padding:20px 0 24px;
      background:linear-gradient(180deg, rgba(12,17,26,0), #0c111a 40%);
      backdrop-filter: blur(8px);
    }
    .panelCta a{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      width:100%;
      padding:18px;
      text-align:center;
      background:linear-gradient(135deg, var(--verified), #5FBBE0);
      color:#001018;
      font-weight:900;
      text-decoration:none;
      border-radius:14px;
      box-shadow:0 12px 28px rgba(125,203,234,.25);
      transition: all 0.2s;
      font-size:16px;
    }
    .panelCta a:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 36px rgba(125,203,234,.35);
    }
    .panelCta svg{
      width:20px;
      height:20px;
      stroke:currentColor;
      fill:none;
      stroke-width:2.5;
      stroke-linecap:round;
      stroke-linejoin:round;
    }

    /* FOOTER (sidebar) */
    .dir-footer{
      padding:16px 18px;
      font-size:12px;
      color:#b9c6dd;
      border-top:1px solid rgba(255,255,255,.08);
      background:#0b0e13;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-shrink:0;
    }
    .dir-footer a{
      color:#cfe0ff;
      text-decoration:none;
      margin-left:14px;
      transition: color 0.2s;
    }
    .dir-footer a:hover{color:#fff}

    /* MOBILE */
    @media(max-width:900px){
      .wrap{grid-template-columns:1fr}
      .sidebar{display:none}
      .panel{width:100%; padding:20px 20px 0}
      .panelTitle h2{font-size:22px}
      .contactGrid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <img src="https://storage.googleapis.com/msgsndr/HjPB77l6JDSqhEzt2YNT/media/66c4a87c66f58d551de0ed1f.png" alt="Prime Regenerative">
  <div>
    <a href="https://www.primeregenerative.com/" target="_blank" rel="noopener">Home</a>
    <a href="https://primeregenerative.com/verified-directory" target="_blank" rel="noopener">About Prime Verified</a>
    <a href="https://primeregenerative.com/verified-directory" target="_blank" rel="noopener">Clinic Owner?</a>
  </div>
</div>

<div class="wrap">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-scroll">
    <div class="search">
      <h1>Browse our Directory of Top Regenerative and Functional Medicine Providers</h1>
      <p>Vetted, trusted clinics approved through our rigorous Prime Regenerative screening process.</p>

      <input id="q" type="text" placeholder="Search clinic, city, or state…" />

      <div class="search-row">
        <div class="pills" id="pills"></div>
        <button class="clearBtn" id="clearBtn" type="button">Clear</button>
      </div>
    </div>

    <div class="filter" id="typeFilter">
      <h3>TYPE</h3>
      <div class="chips">
        <div class="chip active" data-type="all">All</div>
        <div class="chip" data-type="regenerative">Regenerative</div>
        <div class="chip" data-type="functional">Functional</div>
      </div>
    </div>

    <div class="filter" id="serviceFilter">
      <h3>SERVICES</h3>
      <div class="chips">
        <div class="chip" data-service="PRP">PRP</div>
        <div class="chip" data-service="Exosomes">Exosomes</div>
        <div class="chip" data-service="Wharton's Jelly">Wharton's Jelly</div>
        <div class="chip" data-service="Shockwave">Shockwave</div>
        <div class="chip" data-service="Peptides">Peptides</div>
        <div class="chip" data-service="Hormone Therapy">Hormone Therapy</div>
        <div class="chip" data-service="IV Therapy">IV Therapy</div>
        <div class="chip" data-service="Joint Pain">Joint Pain</div>
        <div class="chip" data-service="Hair Loss">Hair Loss</div>
        <div class="chip" data-service="Weight Loss">Weight Loss</div>
      </div>
    </div>

    <div class="filter">
      <h3>VERIFIED</h3>
      <div class="toggle">
        <span>Prime Verified only</span>
        <input type="checkbox" id="verifiedOnly">
      </div>
    </div>

    <div class="count" id="count">
      <span>Loading clinics…</span>
      <small id="breakdown"></small>
    </div>

    <!-- Clinic list -->
    <div class="list" id="list"></div>
    </div>

    <!-- FOOTER -->
    <div class="dir-footer">
      <div>© 2025 Prime Regenerative</div>
      <div>
        <a href="https://primeregenerative.com/privacy" target="_blank" rel="noopener">Privacy</a>
        <a href="https://primeregenerative.com/terms-of-service-7568" target="_blank" rel="noopener">Terms</a>
        <a href="https://primeregenerative.com/verified-directory" target="_blank" rel="noopener">Clinic Owner?</a>
      </div>
    </div>
  </aside>

  <!-- MAP -->
  <div id="map"></div>
</div>

<!-- SIDE PANEL -->
<div class="panel" id="panel"></div>

<script>
  /* MAPBOX TOKEN */
  mapboxgl.accessToken =
    'pk.eyJ1IjoicHJpbWVyZWdlbmVyYXRpdmUiLCJhIjoiY21rZTk1dHB4MDRiYjNlcHBheTJubGh0ayJ9.R9IN8o-u1xnjry7a8BkMsw';

  /* APPS SCRIPT ENDPOINT (APPROVED-ONLY JSON) */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxs9SA3C7rRMgoxWNTFqZ5Ouyy603WpIgczlwvANtlvmHWfCI5QSwXb0BJvax5MqCGF/exec';

  const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/light-v11',
    center:[-98,39],
    zoom:3.4,
    renderWorldCopies: false,
    maxBounds: [[-180, -85], [180, 85]]
  });
  map.addControl(new mapboxgl.NavigationControl());

  const panel = document.getElementById('panel');
  const countEl = document.getElementById('count');
  const breakdownEl = document.getElementById('breakdown');
  const listEl = document.getElementById('list');
  const pillsEl = document.getElementById('pills');
  const qEl = document.getElementById('q');

  // Filter state
  let TYPE = 'all';
  let SERVICES = new Set();
  let VERIFIED_ONLY = false;
  let Q = '';

  // Data
  let ALL = [];
  let markers = [];
  const markerById = new Map();

  function normalizeType(row){
    const raw = String(row.type || '').toLowerCase().trim();
    if (raw === 'functional' || raw === 'regenerative') return raw;
    if (raw.includes('functional')) return 'functional';
    if (raw.includes('regenerative')) return 'regenerative';
    return raw || 'regenerative';
  }

  function isVerified(row){
    return String(row.tier || '').toLowerCase().trim() === 'verified';
  }

  function normalizeServices(row){
    return String(row.services || '')
      .split(',')
      .map(s => s.trim().replace(/[\u2018\u2019]/g, "'")) // normalize curly apostrophes
      .filter(Boolean);
  }

  function safeSite(url){
    const u = String(url || '').trim();
    if (!u) return '#';
    if (u.startsWith('http://') || u.startsWith('https://')) return u;
    return 'https://' + u;
  }

  function formatPhone(phone){
    const p = String(phone || '').replace(/\D/g,'');
    if (p.length === 10) return `(${p.slice(0,3)}) ${p.slice(3,6)}-${p.slice(6)}`;
    if (p.length === 11) return `+${p[0]} (${p.slice(1,4)}) ${p.slice(4,7)}-${p.slice(7)}`;
    return phone || '';
  }

  function toClinic(row){
    const services = normalizeServices(row);
    const cityState = [row.city, row.state].filter(Boolean).join(', ');
    
    // Safely normalize yes/no fields
    const safeYesNo = (val) => {
      const v = String(val || '').toLowerCase().trim();
      if (v === 'yes') return 'Yes';
      if (v === 'no') return 'No';
      return 'Unknown';
    };
    
    return {
      id: row.id || row.slug || row.clinic_name || Math.random().toString(36).slice(2),
      name: row.clinic_name || row.name || 'Unnamed Clinic',
      slug: row.slug || '',
      type: normalizeType(row),
      verified: isVerified(row),
      address: row.address || '',
      city: cityState,
      lat: Number(row.lat),
      lng: Number(row.lng),
      phone: String(row.phone || ''),
      phoneFormatted: formatPhone(row.phone),
      website: safeSite(row.website),
      email: row.public_email || '',
      services,
      description: row.description || '',
      logo_url: row.logo_url || '',
      accepting: safeYesNo(row.accepting_new_patients),
      telehealth: safeYesNo(row.telehealth),
      financing: row.financing_available || 'Unknown'
    };
  }

  function matchesSearch(c){
    if (!Q) return true;
    const hay = `${c.name} ${c.city} ${c.address} ${c.services.join(' ')}`.toLowerCase();
    return hay.includes(Q);
  }

  function hasServices(c){
    if (SERVICES.size === 0) return true;
    const set = new Set(c.services.map(s => s.toLowerCase().replace(/[\u2018\u2019]/g, "'")));
    for (const want of SERVICES){
      const normalized = want.toLowerCase().replace(/[\u2018\u2019]/g, "'");
      if (!set.has(normalized)) return false;
    }
    return true;
  }

  function passesFilters(c){
    if (!Number.isFinite(c.lat) || !Number.isFinite(c.lng)) return false;
    if (TYPE !== 'all' && c.type !== TYPE) return false;
    if (VERIFIED_ONLY && !c.verified) return false;
    if (!hasServices(c)) return false;
    if (!matchesSearch(c)) return false;
    return true;
  }

  function flyToClinic(c){
    map.flyTo({ center:[c.lng, c.lat], zoom:12.5, speed:1.4, curve:1.3 });
  }

  function createAllMarkers(){
    // Create markers once for all clinics
    ALL.forEach(c => {
      if (!Number.isFinite(c.lat) || !Number.isFinite(c.lng)) return;

      const el = document.createElement('div');
      el.className = 'marker' + (c.verified ? ' verified' : '');

      el.onclick = (e) => {
        e.stopPropagation();
        openPanel(c);
      };

      const marker = new mapboxgl.Marker({
        element: el,
        anchor: 'center'
      })
        .setLngLat([c.lng, c.lat])
        .addTo(map);

      markers.push(marker);
      markerById.set(c.id, marker);
    });
  }

  function updateMarkerVisibility(){
    // Show/hide markers based on filters instead of recreating them
    ALL.forEach(c => {
      const marker = markerById.get(c.id);
      if (!marker) return;

      const el = marker.getElement();
      if (passesFilters(c)) {
        el.style.display = '';
      } else {
        el.style.display = 'none';
      }
    });
  }

  function openPanel(c){
    const logo = c.logo_url
      ? `<img class="panelLogo" src="${c.logo_url}" alt="${c.name} logo">`
      : `<div class="panelLogo" aria-hidden="true"></div>`;

    const typeLabel = c.type === 'functional' ? 'Functional Medicine' : 'Regenerative Medicine';

    const verifiedBadge = c.verified 
      ? `<div class="badge">
          <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path></svg>
          Prime Verified Clinic
        </div>`
      : `<div class="badge" style="opacity:.5;color:#dbe3f1;text-shadow:none;font-weight:600">Prime Directory Listing</div>`;

    const phoneBtn = c.phone 
      ? `<a href="tel:${c.phone}" class="contactBtn">
          <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"></path></svg>
          ${c.phoneFormatted || 'Call'}
        </a>`
      : '';

    const emailBtn = c.email 
      ? `<a href="mailto:${c.email}" class="contactBtn">
          <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
          Email
        </a>`
      : '';

    const contactSection = (phoneBtn || emailBtn)
      ? `<div class="contactGrid">${phoneBtn}${emailBtn}</div>`
      : '';

    panel.innerHTML = `
      <div class="panelHeader">
        ${logo}
        <div class="panelTitle">
          <h2>${c.name}</h2>
          ${verifiedBadge}
        </div>
      </div>

      <div class="panelMeta">
        <div class="metaRow">
          <svg class="metaIcon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <div>${typeLabel}</div>
        </div>
        <div class="metaRow">
          <svg class="metaIcon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
          <div>${c.city || c.address}</div>
        </div>
        ${c.services.length ? `<div class="metaRow">
          <svg class="metaIcon" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"></path></svg>
          <div>${c.services.join(', ')}</div>
        </div>` : ''}
      </div>

      ${c.description ? `<div class="desc">${c.description}</div>` : ''}

      ${contactSection}

      <div class="infoCards">
        <div class="infoCard">
          <div class="infoCard-label">New Patients</div>
          <div class="infoCard-value ${c.accepting === 'Yes' ? 'yes' : c.accepting === 'No' ? 'no' : ''}">${c.accepting}</div>
        </div>
        <div class="infoCard">
          <div class="infoCard-label">Telehealth</div>
          <div class="infoCard-value ${c.telehealth === 'Yes' ? 'yes' : c.telehealth === 'No' ? 'no' : ''}">${c.telehealth}</div>
        </div>
      </div>

      <div class="panelCta">
        <a href="${c.website}" target="_blank" rel="noopener">
          Visit Clinic Website
          <svg viewBox="0 0 24 24"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>
        </a>
      </div>
    `;
    panel.classList.add('open');
  }

  function setPills(){
    const pills = [];

    if (TYPE !== 'all') pills.push({ key:'type', label:`Type: ${TYPE}` });

    for (const s of SERVICES){
      pills.push({ key:'svc', value:s, label:s });
    }

    if (VERIFIED_ONLY) pills.push({ key:'verified', label:'Prime Verified only' });

    if (Q) pills.push({ key:'q', label:`Search: "${Q}"` });

    pillsEl.innerHTML = pills.map(p => `
      <div class="pill" data-key="${p.key}" data-value="${p.value || ''}">
        <b>${p.label}</b><span class="x">✕</span>
      </div>
    `).join('');

    pillsEl.querySelectorAll('.pill').forEach(el => {
      el.addEventListener('click', () => {
        const key = el.dataset.key;
        const val = el.dataset.value;

        if (key === 'type') TYPE = 'all';
        if (key === 'svc') SERVICES.delete(val);
        if (key === 'verified') VERIFIED_ONLY = false;
        if (key === 'q'){ Q = ''; qEl.value = ''; }

        syncUIFromState();
        render();
      });
    });
  }

  function syncUIFromState(){
    // Type chips
    document.querySelectorAll('#typeFilter .chip').forEach(chip => {
      chip.classList.toggle('active', (chip.dataset.type || 'all') === TYPE);
    });

    // Service chips
    document.querySelectorAll('#serviceFilter .chip').forEach(chip => {
      const svc = (chip.dataset.service || '').toLowerCase();
      chip.classList.toggle('active', SERVICES.has(svc));
    });

    // Verified toggle
    const v = document.getElementById('verifiedOnly');
    v.checked = VERIFIED_ONLY;

    setPills();
  }

  function renderList(list){
    listEl.innerHTML = list.map(c => {
      const tagClass = c.verified ? 'tag verified' : 'tag';
      const tagText  = c.verified ? 'Prime Verified' : 'Standard';
      const cardClass = c.verified ? 'card verified' : 'card';
      const logo = c.logo_url
        ? `<img class="cardLogo" src="${c.logo_url}" alt="${c.name} logo">`
        : `<div class="cardLogo" aria-hidden="true"></div>`;

      const topSvcs = c.services.slice(0,3).map(s => `<span class="svcPill">${s}</span>`).join('');

      return `
        <div class="${cardClass}" data-id="${c.id}">
          <div class="cardTop">
            ${logo}
            <div class="cardTitle">
              <strong>${c.name}</strong>
              <span>${c.city || c.address}</span>
            </div>
            <span class="${tagClass}">${tagText}</span>
          </div>
          ${topSvcs ? `<div class="cardServices">${topSvcs}</div>` : ''}
        </div>
      `;
    }).join('');

    listEl.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', () => {
        const id = card.dataset.id;
        const c = ALL.find(x => x.id === id);
        if (!c) return;
        flyToClinic(c);
        openPanel(c);
      });
    });
  }

  function render(){
    const list = ALL.filter(passesFilters);

    // Count + breakdown
    const verifiedCount = list.filter(c => c.verified).length;
    const standardCount = list.length - verifiedCount;

    countEl.querySelector('span').textContent = `Showing ${list.length} clinics`;
    breakdownEl.textContent = `${verifiedCount} Prime Verified • ${standardCount} Standard`;

    // Update marker visibility instead of recreating
    updateMarkerVisibility();

    // Sidebar list
    renderList(list);

    // Pills
    setPills();
  }

  function wireUI(){
    // TYPE chips
    document.querySelectorAll('#typeFilter .chip').forEach(chip => {
      chip.addEventListener('click', () => {
        TYPE = chip.dataset.type || 'all';
        syncUIFromState();
        render();
      });
    });

    // SERVICE chips (multi-select)
    document.querySelectorAll('#serviceFilter .chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const svc = (chip.dataset.service || '').toLowerCase();
        if (!svc) return;

        if (SERVICES.has(svc)) SERVICES.delete(svc);
        else SERVICES.add(svc);

        syncUIFromState();
        render();
      });
    });

    // Verified only toggle
    const v = document.getElementById('verifiedOnly');
    v.addEventListener('change', () => {
      VERIFIED_ONLY = !!v.checked;
      syncUIFromState();
      render();
    });

    // Search with debounce
    let searchTimeout;
    qEl.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        Q = qEl.value.trim().toLowerCase();
        setPills();
        render();
      }, 300);
    });

    // Clear
    document.getElementById('clearBtn').addEventListener('click', () => {
      TYPE = 'all';
      SERVICES = new Set();
      VERIFIED_ONLY = false;
      Q = '';
      qEl.value = '';
      syncUIFromState();
      render();
    });

    // Close panel when clicking map
    map.on('click',()=>panel.classList.remove('open'));
  }

  async function loadClinics(){
    countEl.querySelector('span').textContent = 'Loading clinics…';
    breakdownEl.textContent = '';
    try{
      const res = await fetch(ENDPOINT, { cache: 'no-store' });
      const rows = await res.json();
      ALL = (Array.isArray(rows) ? rows : []).map(toClinic);
      
      // Create markers once
      createAllMarkers();
      
      wireUI();
      syncUIFromState();
      render();
    }catch(err){
      console.error('Failed to load clinics', err);
      countEl.querySelector('span').textContent = 'Failed to load clinics';
      breakdownEl.textContent = '';
    }
  }

  loadClinics();
</script>

</body>
</html>
